<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Suma de dos fracciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      text-align: center;
      margin: 20px auto;
      max-width: 900px;
    }
    h1 { margin-bottom: 6px; }
    .explicacion {
      margin-top: 20px;
      font-size: 22px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    .fraccion {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .numerador, .denominador {
      color: blue;
      font-weight: bold;
      font-size: 22px;
    }
    .linea {
      width: 40px;
      border-top: 2px solid black;
      margin: 2px 0;
    }
    .operador {
      color: red;
      font-weight: bold;
      font-size: 26px;
      line-height: 1;
    }
    .contenedor-fracciones {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 30px 0;
      gap: 16px;
      flex-wrap: wrap;
    }
    .fraccion-input {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0 10px;
    }
    .input-num, .input-den {
      width: 70px;
      height: 36px;
      text-align: center;
      font-size: 20px;
      color: blue;
      font-weight: bold;
      margin: 5px 0;
      border-radius: 6px;
      border: 1px solid #bbb;
      background: white;
    }
    .linea-input {
      width: 80px;
      border-top: 2px solid black;
    }
    button {
      margin-top: 12px;
      padding: 10px 18px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .calcular-btn { background-color: #4CAF50; color: white; }
    .repetir-btn { background-color: gray; color: white; display: none; margin-left: 8px; }
    .cerrar-btn { margin-top: 24px; background-color: red; color: white; }
    .procedimiento {
      margin-top: 26px;
      font-size: 22px;
      color: black;
    }
    .resultado-final {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 18px;
      font-size: 24px;
      font-weight: bold;
      gap: 10px;
    }
    .resultado-final span { color: green; }
    .cronometro, .contador-operaciones {
      font-size: 18px;
      color: green;
      margin-top: 10px;
    }
  </style>

  <script>
    const SIM_KEY = "suma_fracciones";

    let operaciones = 0;
    let startAt = 0;
    let timerId = null;
    let sent = false;      // evita doble envÃ­o
    let usuarioId = null;  // se obtiene desde /api/auth/usuario

    async function obtenerUsuarioId() {
      try {
        const res = await fetch("http://localhost:3001/api/auth/usuario", {
          method: "GET",
          credentials: "include"
        });
        if (!res.ok) throw new Error("No autenticado");
        const data = await res.json();
        usuarioId = data._id; // adapta si tu backend devuelve otra propiedad
        console.log("âœ… usuarioId:", usuarioId);
      } catch (err) {
        console.error("âŒ No se pudo obtener el usuario:", err);
        // puedes decidir cerrar si no hay usuario:
        // window.close();
      }
    }

    function iniciarCronometro() {
      startAt = Date.now();
      timerId = setInterval(() => {
        const totalSec = Math.floor((Date.now() - startAt) / 1000);
        const minutos = Math.floor(totalSec / 60);
        const segundos = totalSec % 60;
        document.getElementById('cronometro').textContent =
          `Tiempo usando el simulador: ${minutos} min ${segundos} seg`;
      }, 1000);
    }

    function detenerCronometro() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
    }

    function mcd(a, b) {
      return b === 0 ? a : mcd(b, a % b);
    }

    function calcularSuma() {
      operaciones++;
      document.getElementById('contador-operaciones').textContent =
        `NÃºmero de operaciones realizadas: ${operaciones}`;

      const num1 = parseInt(document.getElementById('num1').value);
      const den1 = parseInt(document.getElementById('den1').value);
      const num2 = parseInt(document.getElementById('num2').value);
      const den2 = parseInt(document.getElementById('den2').value);

      if (isNaN(num1) || isNaN(den1) || isNaN(num2) || isNaN(den2) || den1 === 0 || den2 === 0) {
        alert("Por favor llena todos los campos correctamente (denominadores distintos de 0).");
        return;
      }

      const mult1 = num1 * den2;
      const mult2 = num2 * den1;
      const sumaNumerador = mult1 + mult2;
      const productoDenominador = den1 * den2;
      const divisor = mcd(Math.abs(sumaNumerador), Math.abs(productoDenominador));

      const numSimplificado = sumaNumerador / divisor;
      const denSimplificado = productoDenominador / divisor;

      document.getElementById('procedimiento').innerHTML = `
        <div>
          (<span style="color:blue;">${num1}</span> <span style="color:red;">Ã—</span> <span style="color:blue;">${den2}</span>)
          <span style="color:red;">+</span>
          (<span style="color:blue;">${num2}</span> <span style="color:red;">Ã—</span> <span style="color:blue;">${den1}</span>)
        </div>
        <div><hr style="width:150px; margin: 5px auto;"></div>
        <div>
          (<span style="color:blue;">${den1}</span> <span style="color:red;">Ã—</span> <span style="color:blue;">${den2}</span>)
        </div>
      `;

      document.getElementById('resultado').innerHTML = `
        <div class="resultado-final">
          <span style="color:red;">=</span>
          <span>${numSimplificado} / ${denSimplificado}</span>
        </div>
      `;

      document.getElementById('repetir-btn').style.display = "inline-block";
    }

    function repetirOperacion() {
      document.getElementById('num1').value = "";
      document.getElementById('den1').value = "";
      document.getElementById('num2').value = "";
      document.getElementById('den2').value = "";
      document.getElementById('procedimiento').innerHTML = "";
      document.getElementById('resultado').innerHTML = "";
      document.getElementById('repetir-btn').style.display = "none";
    }

    // EnvÃ­o confiable incluso al cerrar la pestaÃ±a (usa sendBeacon si estÃ¡ disponible)
    async function enviarRegistroYSalir() {
      if (sent) return;
      sent = true;
      detenerCronometro();

      const totalSec = Math.floor((Date.now() - startAt) / 1000);
      const payload = {
        simulador: SIM_KEY,
        duracionSegundos: totalSec,
        usuarioId,
        operaciones
      };
      const url = "http://localhost:3001/api/simuladores/track";

      try {
        if (navigator.sendBeacon) {
          const blob = new Blob([JSON.stringify(payload)], { type: "application/json" });
          navigator.sendBeacon(url, blob);
          console.log("ðŸ“¨ Enviado con sendBeacon");
        } else {
          await fetch(url, {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          console.log("âœ… Registro guardado (fetch).");
        }
      } catch (err) {
        console.error("âŒ Error al guardar:", err);
      }
    }

    async function cerrarSimulador() {
      await enviarRegistroYSalir();
      window.close();
    }

    window.addEventListener("beforeunload", enviarRegistroYSalir);

    window.onload = async () => {
      await obtenerUsuarioId();
      iniciarCronometro();
    };
  </script>
</head>

<body>
  <h1>Suma de dos fracciones:</h1>
  <p><strong>En los recuadros en blanco favor de elegir un valor para el numerador y el denominador de cada fracciÃ³n.</strong></p>

  <div id="cronometro" class="cronometro">Tiempo usando el simulador: 0 min 0 seg</div>
  <div id="contador-operaciones" class="contador-operaciones">NÃºmero de operaciones realizadas: 0</div>

  <div class="explicacion">
    <div class="fraccion">
      <div class="numerador">a</div>
      <div class="linea"></div>
      <div class="denominador">c</div>
    </div>
    <div class="operador">+</div>
    <div class="fraccion">
      <div class="numerador">b</div>
      <div class="linea"></div>
      <div class="denominador">d</div>
    </div>
    <div class="operador">=</div>
    <div class="fraccion">
      <div style="font-size:20px;">
        (<span class="numerador">a</span> <span class="operador">Ã—</span> <span class="numerador">d</span>)
        <span class="operador">+</span>
        (<span class="numerador">b</span> <span class="operador">Ã—</span> <span class="numerador">c</span>)
      </div>
      <div class="linea" style="width:180px; margin: 5px auto;"></div>
      <div style="font-size:20px;">
        (<span class="denominador">c</span> <span class="operador">Ã—</span> <span class="denominador">d</span>)
      </div>
    </div>
  </div>

  <div class="contenedor-fracciones">
    <div class="fraccion-input">
      <input type="number" id="num1" class="input-num" placeholder="a" />
      <div class="linea-input"></div>
      <input type="number" id="den1" class="input-den" placeholder="c" />
    </div>
    <div class="operador">+</div>
    <div class="fraccion-input">
      <input type="number" id="num2" class="input-num" placeholder="b" />
      <div class="linea-input"></div>
      <input type="number" id="den2" class="input-den" placeholder="d" />
    </div>
  </div>

  <div>
    <button class="calcular-btn" onclick="calcularSuma()">Calcular</button>
    <button id="repetir-btn" class="repetir-btn" onclick="repetirOperacion()">ðŸ”„ Repetir operaciÃ³n</button>
  </div>

  <button class="cerrar-btn" onclick="cerrarSimulador()">Cerrar simulador</button>

  <div id="procedimiento" class="procedimiento"></div>
  <div id="resultado"></div>
</body>
</html>